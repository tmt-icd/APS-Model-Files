subsystem = APS
component = ICS.HCD.Detector

publish {

    # ────────────────────────────────────────────────────────────────
    currentStates = [
    {
      name = "currentState"
      description = "Detector HCD status."
      parameters = [

        # ───── Identity / Device Info ─────
        {
          name        = "detectorRole"
          type        = string
          description = "Profile role: APT, PIT, or PSH"
        },
        {
          name        = "deviceAdapter"
          type        = string
          description = "Active Micro-Manager device adapter (e.g. AndorSDK3, PVCam)"
        },

        # ───── Acquisition Mode & Buffering ─────
        {
          name        = "acquisitionMode"
          enum        = ["SINGLE","BURST","LOOP"]
          description = "Current acquisition mode."
        },
        {
          name        = "bufferModel"
          enum        = ["SINGLE","CONTAINER","RING"]
          description = "Memory strategy used for data capture"
        },
        {
          name        = "path"
          type        = string
          description = """
              Shared-memory location of the active buffer(s).
                • CONTAINER (burst) : absolute file path of the burst container
                • SINGLE            : absolute file path of the single-shot buffer
                • RING (loop)       : prefix for ring slots; slot i is path + "_" + i
            """
        },
        {
          name        = "cameraState"
          enum        = ["IDLE","BUSY","STREAMING","PAUSED","FAULT","RECOVERING"]
          description = "Camera acquisition state"
        },
        {
          name        = "cameraPresent"
          type        = boolean
          description = "Camera detected and initialized"
        },

        # ───── Cooling Telemetry ─────
        {
          name        = "coolingState"
          enum        = ["Off","Stabilized","Cooling","Drift","NotStabilized","Fault","OverTemperature"]
          description = "Cooling system state"
        },
        {
          name        = "sensorTemperature"
          type        = float
          units       = degC
          description = "Measured detector temperature"
        },
        {
          name        = "coolingTarget"
          type        = float
          units       = degC
          description = "Configured temperature setpoint"
        },
        {
          name        = "coolingPower"
          type        = float
          units       = percent
          description = "TEC power or duty cycle"
        },

        # ───── Timing & Buffer Status ─────
        {
          name        = "integrationTime"
          type        = float
          units       = second
          description = "Exposure duration of last image"
        },
        {
          name        = "frameRate"
          type        = float
          units       = hertz
          description = "Loop mode frame rate"
        },
        {
          name        = "imageSizeBytes"
          type        = integer
          description = "Size of last image buffer in bytes"
        },

        # ───── ROI ─────
        {
          name        = "roiLeft"
          type        = integer
          units       = pix
          description = "ROI left column"
        },
        {
          name        = "roiTop"
          type        = integer
          units       = pix
          description = "ROI top row"
        },
        {
          name        = "roiWidth"
          type        = integer
          units       = pix
          description = "ROI width"
        },
        {
          name        = "roiHeight"
          type        = integer
          units       = pix
          description = "ROI height"
        },

        # ───── Common Detector Settings ─────
        {
          name        = "Binning"
          type        = string
          description = "On-chip binning mode (e.g., 1x1, 2x2)"
        },
        {
          name        = "ShutterMode"
          type        = string
          description = "Shutter mode (e.g., Closed, Rolling, Auto)"
        },

        # ───── Andor-Specific ─────
        {
          name        = "BitDepth"
          type        = integer
          description = "Andor Pixel bit depth"
        },
        {
          name        = "ReadoutMode"
          type        = string
          description = "Andor readout performance mode (e.g., Fast, LowNoise)"
        },

        # ───── Teledyne-Specific ─────
        {
          name        = "PixelFormat"
          type        = string
          description = "Teledyne pixel format string (e.g., Mono14)"
        },
        {
          name        = "Gain"
          type        = string
          description = "Teledyne analog gain (e.g., Low, High, HDR)"
        },
        {
          name        = "CMSMode"
          type        = string
          description = "Teledyne Correlated Multisampling mode (e.g., On, Off)"
        },

        # ───── Error Handling ─────
        {
          name        = "errorCode"
          type        = integer
          description = "Last non-zero error code from SDK or MM"
        },
        {
          name        = "errorMessage"
          type        = string
          description = "Associated human-readable message"
        }
      ]
    }
  ]

  events = [
    {
      name        = "FrameReady"
      description = "Per-frame notification in exposure loop mode: a ring-buffer slot has been filled and is safe for Assembly consumption."
      maxRate     = 0.1
      parameters = [
        {
          name        = "frameSeq"
          type        = long
          description = "Monotonic frame sequence number for the current loop session."
        },
        {
          name        = "ringIndex"
          type        = integer
          description = "Ring buffer slot just written (0..bufferCount-1)."
        },
        {
          name        = "lastFrameTS"
          type        = taiDate
          description = "TAI Timestamp when copy finished"
        },
        {
          name        = "bufferCopyTime"
          type        = float
          units       = millisecond
          description = "Duration of the copy from µManager to shared memory for this frame."
        }
      ]
    }
  ]
}
