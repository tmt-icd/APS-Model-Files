subsystem=APS
component=ICS.PSH.Detector
publish {
	description = "Main Shack-Hartmann events, images and alarms published by the Instrument Control System PSH Detector Assembly"

events = [
    
        {
			name=status
			description="""PSH Detector status event.  This is event is published at 1 Hz"""
			maxRate = 1
			archive=true
            category=STATUS
			attributes=[
				{
					name=assemblyState
					description="""Current Assembly State"""
					enum = ["READY", "DEGRADED", "FAULTED"]
				}
               {
					name=coolingHealth
					description="""Cooling subsystem health classification (mapped from device-specific states)"""
					enum=[Good, Degraded, Bad]
				}
				{
					name=cameraPresent
					description="""Camera detected and initialized"""
					type=boolean
				}
                {
					name=cameraAcquisitionState
					description="""Camera acquisition state"""
					enum=[IDLE, BUSY, STREAMING, PAUSED, FAULT, RECOVERING]
				}
            ]
         }
         {
			name=temperatureStatus
			description="""PIT Detector temperatureStatus event.  The parameter values can change more often than we need to publish them (0.1 Hz)"""
			maxRate = 0.1
			archive=true
            category=STATUS
			attributes=[
        
               {
					name=detectorTemperature
					description="""The current temperature of the detector"""
					type=float
                    units=degC
				}
                {
					name=temperatureSetPoint
					description="""Configured temperature set point"""
					type=float
                    units=degC
				}
            ]
        }
        
        {
			name=setupStatus
			description="""PSH Detector setupStatus event.  These parameters change only at the start of the PIT Loop or when setting setting the detector temp and are only published when one or more changes value"""
			maxRate = 1.0
			archive=true
            category=STATUS
            attributes=[
        
				{
					name=imageSize
					description="""The buffer size in bytes required to store the data for one frame."""
					type=integer
                    units=NoUnits
				}
				{
					name=acquisitionMode
					description="""Current acquisition mode."""
					enum=[SINGLE, BURST, LOOP]
				}
				{
					name=bufferModel
					description="""Memory strategy used for data capture."""
					enum=[SINGLE, CONTAINER, RING]
				}	
                {
					name=frameRate
					description="""Continuous mode frame rate."""
					type=float
                    units=hertz
				}
				{
					name=path
					description="""Shared-memory location of the active buffer."""
					type=string
                    units=NoUnits
				}

				{
					name=integrationTime
					description="""The currently configured integration time."""
					type=float
                    units=millisecond
				}
                {
					name=roiStartRow
					description="""Starting row of region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiStartCol
					description="""Starting col of region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiHeight
					description="""Number of rows in the region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiWidth
					description="""Number of columns in the region of interest"""
					type=integer
                    units=pix
				}
                { 
                    name = "hBin"
                    description = "Horizontal Binning in pixels"
                    type = integer
                    units = pix

                }
                { 
                    name = "vBin"
                    description = "Vertical Binning in pixels"
                    type = integer
                    units = pix
                }

            ]
        }
                
        {
			name=configStatus
			description="""PSH Detector configStatus event.  These parameters typically do not change value during normal operations, but might change during instrument characterization and AIV.  Only published on  when the assembly sends the configureDetector command to the Teledyne HCD """
			maxRate = 0.01
			archive=true
            category=STATUS
            attributes=[

				{
					name=analogGain
					description="""The current gain processing mode.  HDR combines High and Low gain exposures to increase dynamic range at the cost of readout speed."""
					enum=[LOW, HIGH, HDR]
				}				
                {
					name=bitDepth
					description="""Resolution of pixel digitization in bits/pixel."""
					enum=[14-bit, 16-bit]
				}
				{
					name=shutterMode
					description="""The current shutter control mode."""
					enum=[Rolling, Global]
				}
				{
					name=cms
					description="""Correlated Multisampling Mode (CMS).   When enabled, CMS will produce the lowest read noise."""
					enum=[ON, OFF]
				}
  				
            ]
         
        }
        {
			name=apsAlertEvent
			archive=true
			description="""Event used to communicate that an unexpected condition occured."""
			maxRate = 1
            category=EVENT
			archive=true
			attributes=[
				{
					name=messageSeverity
					description="""Unhandled errors require filling the message field, whereas other types should fill in the messageId"""
					enum = [WARN, ERROR, UNHANDLED_ERROR]
                }
				{
					name=source
					description="""Sensor originating warnings, errors, controller error codes/messages reported from the controller, and warnings/errors that are a result of calculations"""
					enum = [SENSOR, HARDWARE_REPORTED, CALCULATED]
                }
				{
					name=messageId
					description="""Key used within the PEAS UI resource properties configuration file that holds all messages, including information about where to extract and format procedure data values for inclusion in the message"""
					type=string
                }
				{
					name=message
					description="""Message supplied by the event source for unhandled errors"""
					type=string
                }
			]
		}
        
        {
			name=exposureStoreCompleted
			description="""PSH Detector exposure store completed event.  Used to notify APS-PEAS of incoming images just stored on the APS Shared disk"""
			maxRate = 0.1
			archive=true
            category=EVENT
			attributes=[
				{
					name=filename
					description="""TThe name of the file on the APS Shared Disk"""
					type=string
				}
				
            ]
        }
        {
			name=exposureArchiveCompleted
			description="""PSH Detector exposure archive completed event.  Used to update APS-PEAS Exposure Service of images that have been stored to DMS"""
			maxRate = 0.1
			archive=true
            category=EVENT
			attributes=[
				{
					name=filename
					description="""The name of the file on the DMS.ENG ancillary file store"""
					type=string
				}
				
            ]
        }

        
        {
			name=startupMetrics
			description="""assembly startup metrics"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=initStartTime
					description="""Assembly initialization start time"""
					type=taiDate
				}
				{
					name=initCompletedTime
					description="""Assembly initialization completed time"""
					type=taiDate
				}
				{
					name=configureStartTime
					description="""Assembly configuration start time"""
					type=taiDate
				}
				{
					name=configureCompletedTime
					description="""Assembly configuration completed time"""
					type=taiDate
				}

			]
		}
        {
			name=tempSetPointCommanded
			description="""detector temperature set point commanded"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=startTemperature
					description="""Current temperature when set point change command sent"""
					type=float
                    units=degC
				}
				{
					name=targetTemperature
					description="""Commanded target temperature"""
                    type=float
					units=degC
				}
			]
		}
                
        {
			name=tempSetPointReached
			description="""detector temperature set point reached the commanded value"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=currentTemperature
					description="""Current temperature of the detector"""
                    type=float
					units=degC
				}
			]
		}

        {
			name=detectorExposureMetrics
			description="""exposure handling metrics"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=imageSizeBytes
					description="""Size of image buffer in bytes."""
					type=float
                    units=NoUnits
				}
				{
					name=integrationTime
					description="""Integration time of the exposure"""
					type=float
					units=second
				}
				{
					name=exposureReadoutTime
					description="""Exposure readout completed time"""
					type=taiDate
				}
				{
					name=imageCorrectionsStartTime
					description="""Start time for image correction algorithms"""
					type=taiDate
				}
				{
					name=imageCorrectionsCompletedTime
					description="""Completion time for image correction algorithms"""
					type=taiDate
				}
				{
					name=imagePublishingStartTime
					description="""Start time for image publishing"""
					type=taiDate
				}
				{
					name=imagePublishingCompletedTime
					description="""Completion time for image publishing"""
					type=taiDate
				}

			]
		}
    
    ]

    observeEvents = [
        ObserveStart
        ObserveEnd
        DataWriteStart
        DataWriteEnd
    ]
    
	images = [
		{
			name = detectorImage
			description = "PSH detector images are used for PEAS alignment analysis."
			channel = viz.aps.pit
			format = FITS
			size = [8120, 8120]
			pixelSize = 4
			maxRate = 0.1
			metadata = [
				{
					name = platescale
					type = float
					description = "platescale of image in arcsec/pixel"
					keyword = SCALE
				}
				{
					name = integrationTime
					type = integer
					description = "integration time of image in ms"
					keyword = ITIME
				}

			]
		}
    ]
    
    alarms = [
        {
            name = hcdNotLocated
            description = """Andor HCD can not be located (HCD is down or location service fault)."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
        {
            name = assemblyDegraded
            description = """Assembly is in the degraded state."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
        {
            name = assemblyFaulted
            description = """Assembly is in the faulted state."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
    ]

}
