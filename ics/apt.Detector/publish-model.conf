subsystem=APS
component=ICS.APT.Detector
publish {
	description = "guiding images published by the Instrument Control System Aquisition, Pointing and Tracking Detector Assembly"


    events = [
    
        {
			name=status
			description="""APT Detector status event.  This paramter set is published at 1 Hz"""
			maxRate = 1
			archive=true
            category=STATUS
			attributes=[
				{
					name=assemblyState
					description="""Current Assembly State"""
					enum = ["READY", "DEGRADED", "FAULTED"]
				}
                {
					name=coolingHealth
					description="""Cooling subsystem health classification (mapped from device-specific states)"""
					enum=[Good, Degraded, Bad]
				}
				{
					name=cameraPresent
					description="""Camera detected and initialized"""
					type=boolean
				}
                {
					name=cameraAcquisitionState
					description="""Camera acquisition state"""
					enum=[IDLE, BUSY, STREAMING, PAUSED, FAULT, RECOVERING]
				}

	
            ]
         
        }
        
                
        {
			name=temperatureStatus
			description="""APT Detector temperature status event."""
			maxRate = 0.1
			archive=true
            category=STATUS
            attributes=[
                {
					name=detectorTemperature
					description="""The current temperature of the detector"""
					type=float
                    units=degC
				}
                {
					name=temperatureSetPoint
					description="""Configured temperature set point"""
					type=float
                    units=degC
				}


            ]
        }
                
        {
			name=setupStatus
			description="""APT Detector setupStatus event.  These parameters change only at the start of a procedure and are only published at the start of an alignment procedure"""
			maxRate = 0.1
			archive=true
            category=STATUS
            attributes=[
				{
					name=imageSize
					description="""The buffer size in bytes required to store the data for one frame."""
					type=integer
                    units=NoUnits
				}
				{
					name=acquisitionMode
					description="""Current acquisition mode."""
					enum=[SINGLE, BURST, LOOP]
				}
				{
					name=bufferModel
					description="""Memory strategy used for data capture."""
					enum=[SINGLE, CONTAINER, RING]
				}	
                {
					name=frameRate
					description="""Continuous mode frame rate."""
					type=float
                    units=hertz
				}
				{
					name=path
					description="""Shared-memory location of the active buffer."""
					type=string
                    units=NoUnits
				}
                { 
                    name = "hBin"
                    description = "Horizontal Binning in pixels"
                    type = integer
                    units = pix

                }
                { 
                    name = "vBin"
                    description = "Vertical Binning in pixels"
                    type = integer
                    units = pix
                }
            ]
        }
                
        {
			name=guidingStatus
			description="""APT Detector guidingStatus event.  These parameters are changed during aquisition in response to guiding pixel flux values change.  Published upon change. """
			maxRate = 1
			archive=true
            category=STATUS
            attributes=[
                
 				{
					name=gainMode
					description="""Current gain mode."""
					enum=["12=bit", "16-bit"]
				}
                {
					name=integrationTime
					description="""Integration time."""
					type=float
                    units=second
				}
                {
					name=roiStartRow
					description="""Starting row of region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiStartCol
					description="""Starting col of region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiHeight
					description="""Number of rows in the region of interest"""
					type=integer
                    units=pix
				}
                {
					name=roiWidth
					description="""Number of columns in the region of interest"""
					type=integer
                    units=pix
				}


            ]
        }

        {
			name=configStatus
			description="""APT Detector configStatus event.  These parameters typically do not change value during normal operations, but might change during instrument characterization and AIV.  Only published on  when the assembly sends the configure command to the Andor HCD """
			maxRate = 0.01
			archive=true
            category=STATUS
            attributes=[

 				{
					name=pixelEncoding
					description="""The format of the data stream."""
					enum=[Mono12, Mono12Packed, Mono16, Mono32, Mono12CXP, Mono18]
				}
 				{
					name=pixelReadoutRate
					description="""Pixel readout rate."""
					enum=[100MHz, 200MHz]
				}
				{
					name=spuriousNoiseFilter
					description="""When true the spurious noise filter is enabled."""
					type=boolean
				}
            ]
         
        }
        {
			name=apsAlertEvent
			archive=true
			description="""Event used to communicate that an unexpected condition occured."""
			maxRate = 1
            category=EVENT
			archive=true
			attributes=[
				{
					name=messageSeverity
					description="""Unhandled errors require filling the message field, whereas other types should fill in the messageId"""
					enum = [WARN, ERROR, UNHANDLED_ERROR]
                }
				{
					name=source
					description="""Sensor originating warnings, errors, controller error codes/messages reported from the controller, and warnings/errors that are a result of calculations"""
					enum = [SENSOR, HARDWARE_REPORTED, CALCULATED]
                }
				{
					name=messageId
					description="""Key used within the PEAS UI resource properties configuration file that holds all alert messages.  Different from procedure events, these alert messages contain placeholders for messageArgs in this alert event."""
					type=string
                }
                {
                    name=messageArgs
                    description="""The message text obtained by the message Id key contains argument placeholders (e.g., {0}, {1}, etc.) that indicate where variable argument values will be inserted. This field provides the ordered list of string values to substitute into the message at the corresponding placeholder positions."""
                    type=string
                }
				{
					name=message
					description="""Message supplied by the event source for unhandled errors"""
					type=string
                }
			]
		}
        
        {
			name=exposureStoreCompleted
			description="""APT Detector exposure store completed event.  Used to notify APS-PEAS of incoming images just stored on the APS Shared disk"""
			maxRate = 10
			archive=true
            category=EVENT
			attributes=[
				{
					name=filename
					description="""The name of the file on the APS Shared Disk"""
					type=string
				}
				
            ]
        }
        {
			name=exposureArchiveCompleted
			description="""APT Detector exposure archive completed event.  Used to update APS-PEAS Exposure Service of images that have been stored to DMS"""
			maxRate = 10
			archive=true
            category=EVENT
			attributes=[
				{
					name=filename
					description="""The name of the file on the DMS.ENG ancillary file store"""
					type=string
				}
				
            ]
        }
        {
			name=startupMetrics
			description="""assembly startup metrics"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=initStartTime
					description="""Assembly initialization start time"""
					type=taiDate
				}
				{
					name=initCompletedTime
					description="""Assembly initialization completed time"""
					type=taiDate
				}
				{
					name=configureStartTime
					description="""Assembly configuration start time"""
					type=taiDate
				}
				{
					name=configureCompletedTime
					description="""Assembly configuration completed time"""
					type=taiDate
				}

			]
		}
        {
			name=tempSetPointCommanded
			description="""detector temperature set point commanded"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=startTemperature
					description="""Current temperature when set point change command sent"""
					type=float
                    units=degC
				}
				{
					name=targetTemperature
					description="""Commanded target temperature"""
                    type=float
					units=degC
				}
			]
		}
                
        {
			name=tempSetPointReached
			description="""detector temperature set point reached the commanded value"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=currentTemperature
					description="""Current temperature of the detector"""
                    type=float
					units=degC
				}
			]
		}


        {
			name=detectorExposureMetrics
			description="""exposure handling metrics"""
			maxRate = 1
            category=ARCHIVE
			archive=true
			attributes=[
				{
					name=imageSizeBytes
					description="""Size of image buffer in bytes."""
					type=float
                    units=NoUnits
				}
				{
					name=integrationTime
					description="""Integration time of the exposure"""
					type=float
					units=second
				}
				{
					name=exposureReadoutTime
					description="""Exposure readout completed time"""
					type=taiDate
				}
				{
					name=imageCorrectionsStartTime
					description="""Start time for image correction algorithms"""
					type=taiDate
				}
				{
					name=imageCorrectionsCompletedTime
					description="""Completion time for image correction algorithms"""
					type=taiDate
				}
				{
					name=imagePublishingStartTime
					description="""Start time for image publishing"""
					type=taiDate
				}
				{
					name=imagePublishingCompletedTime
					description="""Completion time for image publishing"""
					type=taiDate
				}

			]
		}

    ]


	images = [
		{
			name = detectorImage
			description = """The TCS uses APT frames for acquisition and guiding.  To support this function the APS will publish the APT frame data.  The frame will be bias corrected, dark frame subtracted and bad pixel corrected prior to being sent.
            
            The size of the image given is what is expected to be the most common size during guiding.  Acquisition images can the be full detector size = [2048, 2048]
            """
			channel = viz.aps.apt
			format = FITS
			size = [128, 128]
			pixelSize = 2
			maxRate = 10.0
			metadata = [
				{
					name = platescale
					type = float
					description = "platescale of image in arcsec/pixel"
					keyword = SCALE
				}
				{
					name = integrationTime
					type = integer
					description = "integration time of image in ms"
					keyword = ITIME
				}
				{
					name=roiWidth
					type = integer
					description="ROI width in pixels"
					keyword = ROIWIDTH
				}
				{
					name=roiHeight
					type = integer
					description="ROI height in pixels"
					keyword = ROIHEIGHT
				}
				{
					name=roiOffsetX
					type = integer
					description="X ROI offset from the detector full frame from upper corner of ROI to upper corner of detector."
					keyword = ROIOFFSETX
				}
				{
					name=roiOffsetY
					type = integer
					description="Y ROI offset from the detector full frame from upper corner of ROI to upper corner of detector."
					keyword = ROIOFFSETY
				}

			]
		}

	]
    alarms = [
        {
            name = hcdNotLocated
            description = """Andor HCD can not be located (HCD is down or location service fault)."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
        {
            name = assemblyDegraded
            description = """Assembly is in the degraded state."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
        {
            name = assemblyFaulted
            description = """Assembly is in the faulted state."""
            // TODO FIXME: The fields below were automatically added and should be updated manually
            severityLevels = [Major]
            location = "TBD..."
            alarmType = Calculated
            probableCause = "TBD..."
            operatorResponse = "TBD..."
            autoAck = false
            latched = false
        }
        
// This should be a notification event to the APS PEAS or APS Engineering UI        
        
        {
            name = detectorTemperatureHighWarning
            description = """Detector temperature has exceeded the high warning limit."""
            severityLevels = [Warning]
            location = "APT Detector"
            alarmType = System
            probableCause = "Failure in detector cooling systems"
            operatorResponse = "Monitor image quality"
            autoAck = false
            latched = false
        }
       
        
        
    ]
}
